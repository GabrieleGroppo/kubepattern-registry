{
    "version": "kubepattern.it/v1",
    "kind": "Pattern",
    "metadata": {
        "name": "sidecar",
        "displayName": "Sidecar",
        "patternType": "STRUCTURAL",
        "severity": "INFO",
        "category": "architecture",
        "gitUrl": "https://github.com/GabrieleGroppo/kubepattern-registry/tree/main/doc/sidecar-pattern.md",
        "docUrl": "https://github.com/GabrieleGroppo/kubepattern-registry/tree/main/doc/sidecar-pattern.json"
    },
    "spec": {
        "description": "Identifies pods that should implement the sidecar pattern but are incorrectly separated into different pods. The sidecar pattern places helper containers alongside the main application container in the same pod to share lifecycle, network, and storage resources. Common use cases include logging, monitoring, configuration management, and service mesh proxies.",
        "message": "Pod '{{main-app.name}}' in namespace '{{main-app.namespace}}' appears to be separated from its sidecar pod '{{sidecar.name}}' in namespace '{{sidecar.namespace}}'. These pods share volumes and likely have a common lifecycle, suggesting they should be combined into a single pod with multiple containers. This would improve resource sharing, deployment atomicity, and reduce network overhead.",
        "topology": "LEADER_FOLLOWER",
        "leader": "main-app",
        "resources": [
            {
                "resource": "Pod",
                "id": "main-app",
                "filters": {
                    "matchAll": [
                        {
                            "key": ".spec.volumes",
                            "operator": "EXISTS",
                            "values": []
                        }
                    ],
                    "matchNone": [
                        {
                            "key": ".metadata.namespace",
                            "operator": "EQUALS",
                            "values": [
                                "kube-system",
                                "kube-public",
                                "kube-node-lease",
                                "krateo-system"
                            ]
                        }
                    ],
                    "matchAny": [
                        {
                            "key": ".metadata.name",
                            "operator": "EQUALS",
                            "values": [
                                "application",
                                "frontend",
                                "backend",
                                "api",
                                "web",
                                "service"
                            ]
                        },
                        {
                            "key": ".metadata.labels.app",
                            "operator": "EQUALS",
                            "values": [
                                "frontend",
                                "backend",
                                "application"
                            ]
                        },
                        {
                            "key": ".metadata.labels.tier",
                            "operator": "EQUALS",
                            "values": [
                                "web",
                                "api",
                                "frontend",
                                "backend"
                            ]
                        }
                    ]
                }
            },
            {
                "resource": "Pod",
                "id": "sidecar",
                "filters": {
                    "matchAll": [
                        {
                            "key": ".spec.volumes",
                            "operator": "EXISTS",
                            "values": []
                        }
                    ],
                    "matchNone": [
                        {
                            "key": ".metadata.namespace",
                            "operator": "EQUALS",
                            "values": [
                                "kube-system",
                                "kube-public",
                                "kube-node-lease"
                            ]
                        }
                    ],
                    "matchAny": [
                        {
                            "key": ".metadata.name",
                            "operator": "EQUALS",
                            "values": [
                                "logging",
                                "logger",
                                "log",
                                "log-collector",
                                "log-shipper",
                                "fluentd",
                                "filebeat",
                                "logstash"
                            ]
                        },
                        {
                            "key": ".metadata.labels.app",
                            "operator": "EQUALS",
                            "values": [
                                "logging",
                                "logger",
                                "log-collector"
                            ]
                        },
                        {
                            "key": ".metadata.labels.component",
                            "operator": "EQUALS",
                            "values": [
                                "log-collector",
                                "log-shipper",
                                "logging",
                                "monitoring",
                                "metrics"
                            ]
                        }
                    ]
                }
            }
        ],
        "relationships": [
            {
                "id": "shared-volume-mount",
                "type": "MOUNTS",
                "description": "Both pods mount volumes with the same name or emptyDir type, indicating they are intended to share storage. In a proper sidecar pattern, these containers should share the same pod-level volume.",
                "weight": 0.6,
                "required": true,
                "shared": true,
                "resourceIds": [
                    "main-app",
                    "sidecar"
                ]
            }
        ],
        "confidenceThreshold": 0.7,
        "evidence": {
            "required": [
                "shared-volume-mount",
                "lifecycle-coupling"
            ],
            "optional": [
                "network-locality",
                "functional-assistance",
                "scheduling-affinity"
            ]
        }
    }
}